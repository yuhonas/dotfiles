---
- name: add alacritty repo
  apt_repository:
    repo: ppa:mmstick76/alacritty
    state: present
  become: true

- name: install packages needed to take a screenshot
  package:
    name:
      - alacritty
      - imagemagick
      - neofetch
      - xvfb
      - x11-utils
    state: present
  become: true

- name: check for existing xvfb server
  command: xdpyinfo -display :{{ display_server }}
  register: xserver_running
  ignore_errors: true

- name: start xvfb server
  shell: "Xvfb :{{ display_server }} -screen 0 800x600x24 &"
  when: xserver_running is failed

- name: start terminal
  shell: alacritty --hold --position 0 0 -e neofetch &
  environment:
    DISPLAY: :{{ display_server }}

- name: get a temporary filename for the screenshot
  tempfile:
    state: file
    suffix: ".png"
  register: screenshot_file

- name: take a screenshot
  shell: import -window root -trim {{ screenshot_file.path }}
  environment:
    DISPLAY: :{{ display_server }}

- name: copy screenshot to local machine
  fetch:
    src: "{{ screenshot_file.path }}"
    dest: screenshot.png
    flat: yes
    validate_checksum: no

- name: terminate xvfb server
  command: pkill Xvfb
